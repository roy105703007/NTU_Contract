# 合約架構
## 合約清單
- 控管申請合約
- 申請合約

![](https://i.imgur.com/lDN3Zqy.png)
- 
- 拆帳合約
![](https://i.imgur.com/vSOTaUe.png)




## 控管申請合約!


#### Mapping

    user身分證字號＝＞user申請合約地址 （申請合約清單）

#### Function

    增刪查改申請合約（新增申請合約時，需指定user地址為該申請合約owner）

## 申請合約

#### 申請文件結構
    
    申請ID
    User身分證字號
    申請發起人
    申請項目
    資料傳送對象（誰能查看病歷資料）
    申請期間
    申請狀態
    費用

#### 申請文件狀態異動紀錄結構

    From
    To
    Datetime
    
#### Mapping
    
    申請ID＝＞（申請醫院＝＞申請文件）    （申請文件清單）
這樣設計得目的，是為了讓一份申請文件可以包含多家醫院，一份申請文件對應一組申請ID。
    
    申請ID＝＞申請狀態    （該申請文件狀態）
    申請ID＝＞申請狀態異動紀錄（Struct Array）
    
#### 狀態
- 暫存(不上鏈)
- 等待使用者同意
- 等待付款
- 等待醫院準備
- 等待對方機構下載
- 完成

暫存->等待使用者同意(不上鏈)
    
    使用者透過APP填寫資料，或由保險公司代填，填寫完成後，
    會產生一組申請ID對應到等待使用者同意狀態。
    
暫存->作廢(不上鏈)

    當期間內使用者不同意，將申請文件狀態改為作廢。

等待使用者同意->等待付款
    
    資料於APP上顯示給使用者看，使用者確認資料後，
    使用數位簽章，依先前的申請ID生成申請文件，並將申請ID對應到的狀態改為等待付款。
    只有（等待使用者同意->等待付款）這邊需要使用者的數位簽章。
    
等待付款 -> 作廢

    合約內設置對外接收時間的功能，當繳費期間一到沒有收到
    付款成功的交易，將申請文件狀態改為作廢。
    
等待付款->等待醫院準備
    
    收到付款成功的交易後，將申請文件狀態改成等待醫院準備
    
等待醫院準備->等待下載

    收到醫院準備完成的交易後，將申請文件狀態改成等待對方機構下載
    
等待下載->完成
    
    收到下載完成的交易後，將申請文件狀態改成完成
    

#### Function

    增刪查改申請文件
    更換owner地址、EBM地址、user地址
     
    新增
    查state transaction history
    from、to、改變狀態時間

#### 換機、換密碼

生成新的keystored，由平台方將申請合約的owner換成新的地址

## 拆帳合約
因為每筆申請文件參與的醫院可能不同，每家醫院申請的項目花費也會不同，所以每收到一筆申請文件的付款，就紀錄一次，紀錄該筆申請文件，要分給哪幾家醫院各多少錢。一個月結算一次。
每個月的id會mapping到該月所有的requestID，到了月結算的時候，呼叫合約上的monthlyBalance，對該月所有的申請文件進行結算，用struct array型態紀錄hospitalID和要給該醫院的cost，最後會得到要分給每一家醫院的金額。
#### Mapping

    monthID->(reqID->(hosID->cost))
#### Function

    新增一筆申請文件的拆帳方式
    月結算
舉例每筆申請文件的拆帳方式
申請文件ID:123
hosID:H001
cost:200
hosID:H002
cost:300
紀錄每筆申請文件拆帳方式，每個月再進行總額的結算

    
    